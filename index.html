<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºå­¦é¢˜åº“ PRO - ç¨³å®šåŒæ­¥ç‰ˆ</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>

    <style>
        :root {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --primary: #3b82f6;
            --success: #10b981; --error: #ef4444; --border: #e2e8f0; --subtext: #64748b;
        }
        [data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --primary: #60a5fa;
            --success: #34d399; --error: #fb7185; --border: #334155; --subtext: #94a3b8;
        }
        * { box-sizing: border-box; transition: background 0.2s; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; min-height: 100vh; }
        
        /* ç‰ˆæœ¬ä¸åŒæ­¥æç¤º */
        .sync-banner { background: #1e293b; color: #94a3b8; font-size: 10px; text-align: center; padding: 2px; }

        /* å¯¼èˆªæ  */
        .nav { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .nav-title { font-weight: 900; font-size: 1.1rem; letter-spacing: -0.5px; }

        /* ä¸»å®¹å™¨ */
        .container { max-width: 700px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
        
        /* æœç´¢ä¸åˆ†ç±» */
        .search-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); color: var(--text); margin-bottom: 12px; outline: none; }
        .tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; scrollbar-width: none; }
        .tab { white-space: nowrap; padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); font-size: 13px; cursor: pointer; background: var(--card); }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* é¢˜ç›®å¡ç‰‡ */
        .card { background: var(--card); padding: 24px; border-radius: 18px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; }
        .q-meta { font-size: 12px; color: var(--subtext); margin-bottom: 10px; display: flex; justify-content: space-between; }
        .q-text { font-size: 18px; font-weight: 700; line-height: 1.6; margin-bottom: 20px; }

        /* é€‰é¡¹æ ·å¼ */
        .option { display: flex; align-items: center; padding: 14px; border: 2px solid var(--border); border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .option:hover { border-color: var(--primary); }
        .option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.05); }
        .option.correct { border-color: var(--success); color: var(--success); background: rgba(16, 185, 129, 0.05); }
        .option.error { border-color: var(--error); color: var(--error); background: rgba(239, 68, 68, 0.05); }
        .opt-key { width: 24px; height: 24px; border-radius: 6px; background: var(--bg); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; margin-right: 12px; border: 1px solid var(--border); }

        .analysis { margin-top: 20px; padding: 15px; background: var(--bg); border-radius: 12px; display: none; border-left: 4px solid var(--primary); font-size: 14px; }
        .show { display: block; }

        /* ç®¡ç†é¢æ¿ */
        #mg-panel { display: none; position: fixed; right: 0; top: 0; bottom: 0; width: 100%; max-width: 320px; background: var(--card); border-left: 1px solid var(--border); padding: 20px; z-index: 200; box-shadow: -5px 0 20px rgba(0,0,0,0.1); overflow-y: auto; }
        .panel-on #mg-panel { display: block; }
        
        .btn { padding: 10px 16px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--error); color: white; }

        /* åº•éƒ¨æ§åˆ¶ */
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 15px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: center; gap: 15px; z-index: 50; }
    </style>
</head>
<body>

<div class="sync-banner">
    ä»£ç ç‰ˆæœ¬ï¼š2026.01.05.1700 | å®æ—¶åŠ è½½æ¨¡å¼ (æ— ç¼“å­˜å¹²æ‰°)
</div>

<div class="nav">
    <div class="nav-title" onclick="location.reload()">æ™ºå­¦é¢˜åº“ PRO</div>
    <div style="display: flex; gap: 12px; align-items: center;">
        <span onclick="toggleTheme()" style="cursor:pointer; font-size: 20px;">ğŸŒ“</span>
        <button class="btn btn-ghost" onclick="togglePanel()">ç®¡ç†</button>
    </div>
</div>

<div id="mg-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin:0">é¢˜åº“ç®¡ç†</h3>
        <button class="btn btn-ghost" onclick="togglePanel()">å…³é—­</button>
    </div>
    
    <button class="btn" style="width:100%; margin-bottom:15px" onclick="addBank()">+ æ–°å»ºé¢˜åº“</button>
    <div id="bank-list"></div>
    
    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
    
    <h4>ğŸ“¥ å¯¼å…¥ Docx/Txt</h4>
    <input type="file" id="file-up" accept=".docx,.txt" style="display:none" onchange="importFile(this)">
    <button class="btn btn-ghost" style="width:100%" onclick="document.getElementById('file-up').click()">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
    
    <div id="batch-section" style="margin-top:20px; display:none">
        <h4>æ‰¹é‡ç®¡ç†é¢˜ç›®</h4>
        <button class="btn btn-danger" style="width:100%" onclick="doBatchDel()">åˆ é™¤é€‰ä¸­é¢˜ç›®</button>
        <div id="q-list-mini" style="max-height:180px; overflow-y:auto; font-size:11px; margin-top:10px; border:1px solid var(--border); border-radius:8px; padding:5px;"></div>
    </div>
</div>

<div class="container">
    <input type="text" id="srch" class="search-input" placeholder="è¾“å…¥å…³é”®å­—æœç´¢å½“å‰é¢˜åº“..." oninput="doSearch()">
    
    <div class="tabs">
        <div class="tab active" onclick="setFilter('all')">å…¨éƒ¨</div>
        <div class="tab" onclick="setFilter('single')">å•é€‰</div>
        <div class="tab" onclick="setFilter('multi')">å¤šé€‰</div>
        <div class="tab" onclick="setFilter('judge')">åˆ¤æ–­</div>
        <div class="tab" onclick="setFilter('fill')">å¡«ç©º</div>
        <div class="tab" id="mistake-tab" onclick="toggleMistake()" style="color:var(--error); font-weight:bold;">é”™é¢˜ (<span id="w-count">0</span>)</div>
    </div>

    <div class="card" id="quiz-card">
        <div id="quiz-content">è¯·åœ¨â€œç®¡ç†â€ä¸­æ–°å»ºä¸€ä¸ªé¢˜åº“ï¼Œå¹¶å¯¼å…¥ Docx é¢˜ç›®æ–‡ä»¶ã€‚</div>
    </div>
</div>

<div class="footer">
    <button class="btn btn-ghost" style="flex:1; max-width:120px" onclick="moveQ(-1)">ä¸Šä¸€é¢˜</button>
    <button class="btn" style="flex:2; max-width:240px" onclick="moveQ(1)">ä¸‹ä¸€é¢˜</button>
</div>

<script>
/* ==========================================
   1. æ•°æ®åº“é€»è¾‘ (IndexedDB)
   ========================================== */
let db;
const req = indexedDB.open('SmartQuizDB', 2);
req.onupgradeneeded = e => {
    const d = e.target.result;
    if(!d.objectStoreNames.contains('banks')) d.createObjectStore('banks', {keyPath:'id', autoIncrement:true});
};
req.onsuccess = e => { db = e.target.result; initApp(); };

let curBank = null, pool = [], idx = 0, filter = 'all', keyword = '', mistakeMode = false;

async function initApp() {
    refreshBankUI();
    const lastId = localStorage.getItem('active_bank_id');
    if (lastId) loadBank(parseInt(lastId));
}

async function refreshBankUI() {
    const tx = db.transaction('banks', 'readonly');
    tx.objectStore('banks').getAll().onsuccess = e => {
        const banks = e.target.result;
        document.getElementById('bank-list').innerHTML = banks.map(b => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border:1px solid var(--border); border-radius:10px; margin-bottom:8px; cursor:pointer; background:${curBank?.id===b.id?'rgba(59,130,246,0.1)':'transparent'}" onclick="loadBank(${b.id})">
                <span style="font-size:14px; font-weight:600;">${b.name} (${b.qs.length})</span>
                <span style="color:var(--error); font-size:18px;" onclick="delBank(event, ${b.id})">ğŸ—‘ï¸</span>
            </div>
        `).join('');
    };
}

function loadBank(id) {
    db.transaction('banks', 'readonly').objectStore('banks').get(id).onsuccess = e => {
        curBank = e.target.result;
        if (!curBank) return;
        localStorage.setItem('active_bank_id', id);
        mistakeMode = false;
        applyFilter();
        refreshBankUI();
        drawBatchUI();
    };
}

/* ==========================================
   2. é¢˜ç›®è§£æä¸è¿‡æ»¤
   ========================================== */
function applyFilter() {
    if (!curBank) return;
    let base = mistakeMode ? curBank.qs.filter(q => curBank.wrongs.includes(q.id)) : curBank.qs;
    if (filter !== 'all') base = base.filter(q => q.type === filter);
    if (keyword) base = base.filter(q => q.question.toLowerCase().includes(keyword.toLowerCase()));
    pool = base; idx = 0;
    document.getElementById('w-count').innerText = curBank.wrongs.length;
    renderQ();
}

function renderQ() {
    const area = document.getElementById('quiz-content');
    if (!pool.length) { 
        area.innerHTML = `<center style="padding:40px; color:var(--subtext)">${mistakeMode?'é”™é¢˜æœ¬å·²æ¸…ç©ºï¼ğŸ‘':'æ²¡æ‰¾åˆ°ç›¸å…³é¢˜ç›®'}</center>`; 
        return; 
    }
    
    const q = pool[idx], done = q.uAns !== undefined;
    let opts = q.options || [];
    // åˆ¤æ–­é¢˜è‡ªåŠ¨è¡¥å…¨é€‰é¡¹
    if (q.type === 'judge' && !opts.length) opts = [{label:'A', content:'å¯¹'}, {label:'B', content:'é”™'}];

    area.innerHTML = `
        <div class="q-meta">
            <span>${idx + 1} / ${pool.length} [${translateType(q.type)}]</span>
            ${curBank.wrongs.includes(q.id) ? '<b style="color:var(--error)">[é”™é¢˜]</b>' : ''}
        </div>
        <div class="q-text">${highlight(q.question)}</div>
        <div class="options-list">
            ${q.type === 'fill' ? `<input type="text" class="search-input" id="fill-in" value="${q.uAns||''}" ${done?'disabled':''} placeholder="è¾“å…¥ç­”æ¡ˆåæŒ‰å›è½¦">` : 
            opts.map((o, i) => {
                let c = '';
                if(done) {
                    const isCorrect = Array.isArray(q.answer) ? q.answer.includes(o.label) : q.answer === o.label;
                    const isSelected = Array.isArray(q.uAns) ? q.uAns.includes(o.label) : q.uAns === o.label;
                    if(isCorrect) c = 'correct'; else if(isSelected) c = 'error';
                } else if(q.tmp?.includes(o.label)) c = 'selected';
                return `<div class="option ${c}" onclick="handleSelection('${o.label}')"><div class="opt-key">${i+1}</div>${o.content}</div>`;
            }).join('')}
        </div>
        <div class="analysis ${done?'show':''}">
            <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">
            <b>æ­£ç¡®ç­”æ¡ˆï¼š</b> <span style="color:var(--success)">${Array.isArray(q.answer)?q.answer.join(''):q.answer}</span><br>
            ${q.analysis || 'æš‚æ— è¯¦ç»†è§£æ'}
        </div>
    `;
}

function handleSelection(label) {
    const q = pool[idx]; if (q.uAns) return;
    if (q.type === 'multi') {
        if(!q.tmp) q.tmp = [];
        const p = q.tmp.indexOf(label); p > -1 ? q.tmp.splice(p, 1) : q.tmp.push(label);
        renderQ();
    } else {
        q.uAns = label; judgeQ(q); renderQ();
    }
}

function judgeQ(q) {
    const isRight = Array.isArray(q.answer) ? 
        (JSON.stringify(q.uAns.sort()) === JSON.stringify(q.answer.sort())) : 
        (q.uAns === q.answer);
    
    if (!isRight) {
        if(!curBank.wrongs.includes(q.id)) curBank.wrongs.push(q.id);
    } else if (mistakeMode) {
        curBank.wrongs = curBank.wrongs.filter(id => id !== q.id);
    }
    const tx = db.transaction('banks', 'readwrite');
    tx.objectStore('banks').put(curBank);
    document.getElementById('w-count').innerText = curBank.wrongs.length;
}

/* ==========================================
   3. æ–‡ä»¶è§£æ (Mammoth)
   ========================================== */
async function importFile(input) {
    if(!curBank) return alert("è¯·å…ˆæ–°å»ºæˆ–é€‰æ‹©ä¸€ä¸ªé¢˜åº“");
    const file = input.files[0]; if(!file) return;
    let txt = "";
    if (file.name.endsWith('.docx')) {
        const ab = await file.arrayBuffer();
        const res = await mammoth.extractRawText({ arrayBuffer: ab });
        txt = res.value;
    } else { txt = await file.text(); }
    
    const newQs = parseContent(txt);
    curBank.qs = [...curBank.qs, ...newQs];
    const tx = db.transaction('banks', 'readwrite');
    tx.objectStore('banks').put(curBank).onsuccess = () => { loadBank(curBank.id); alert(`æˆåŠŸå¯¼å…¥ ${newQs.length} é“é¢˜ç›®ï¼`); };
}

function parseContent(t) {
    const res = [];
    const lines = t.split('\n').map(l => l.trim()).filter(l => l);
    let cur = null;
    const typeMap = {"å•é€‰é¢˜":"single", "å¤šé€‰é¢˜":"multi", "åˆ¤æ–­é¢˜":"judge", "å¡«ç©ºé¢˜":"fill"};
    
    lines.forEach((l, i) => {
        const mQ = l.match(/^(\d+)\.\s*\[(å•é€‰é¢˜|å¤šé€‰é¢˜|åˆ¤æ–­é¢˜|å¡«ç©ºé¢˜)\]\s*(.*)/);
        if (mQ) {
            cur = { id: Date.now() + i, type: typeMap[mQ[2]]||"single", question: mQ[3], options: [], answer: "" };
            res.push(cur);
        } else if (cur) {
            const mO = l.match(/^([A-F])\.\s*(.*)/);
            if (mO) cur.options.push({ label: mO[1], content: mO[2] });
            const mA = l.match(/^æ­£ç¡®ç­”æ¡ˆ[ï¼š:]\s*(.*)/);
            if (mA) cur.answer = cur.type === 'multi' ? mA[1].trim().split('') : mA[1].trim();
        }
    });
    return res;
}

/* ==========================================
   4. äº¤äº’åŠŸèƒ½
   ========================================== */
function moveQ(step) { if(pool[idx+step]) { idx += step; renderQ(); } }
function addBank() { const n = prompt("è¾“å…¥é¢˜åº“åç§°:"); if(n) db.transaction('banks','readwrite').objectStore('banks').add({name:n, qs:[], wrongs:[]}).onsuccess = refreshBankUI; }
function delBank(e, id) { e.stopPropagation(); if(confirm("ç¡®å®šåˆ é™¤è¯¥é¢˜åº“åŠæ‰€æœ‰è®°å½•å—ï¼Ÿ")) db.transaction('banks','readwrite').objectStore('banks').delete(id).onsuccess = refreshBankUI; }
function setFilter(t) { filter = t; document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.innerText.includes(t)|| (t==='all'&&el.innerText==='å…¨éƒ¨'))); applyFilter(); }
function toggleMistake() { mistakeMode = !mistakeMode; document.getElementById('mistake-tab').classList.toggle('active', mistakeMode); applyFilter(); }
function doSearch() { keyword = document.getElementById('srch').value; applyFilter(); }
function togglePanel() { document.body.classList.toggle('panel-on'); }
function toggleTheme() { document.documentElement.setAttribute('data-theme', document.documentElement.getAttribute('data-theme')==='light'?'dark':'light'); }
function translateType(t) { return {single:'å•é€‰', multi:'å¤šé€‰', judge:'åˆ¤æ–­', fill:'å¡«ç©º'}[t]; }
function highlight(t) { if(!keyword) return t; return t.replace(new RegExp(`(${keyword})`, 'gi'), '<mark style="background:#fde047; color:#000;">$1</mark>'); }

// é”®ç›˜æ˜ å°„
window.onkeydown = e => {
    const q = pool[idx]; if(!q) return;
    if (e.key >= '1' && e.key <= '4' && q.type !== 'fill') handleSelection(['A','B','C','D'][e.key-1]);
    if (e.key === 'ArrowLeft') moveQ(-1);
    if (e.key === 'ArrowRight') moveQ(1);
    if (e.key === 'Enter') {
        if (q.type === 'fill' && !q.uAns) { const v = document.getElementById('fill-in').value.trim(); if(v){q.uAns=v; judgeQ(q); renderQ();} }
        else if (q.type === 'multi' && !q.uAns && q.tmp?.length) { q.uAns = q.tmp; judgeQ(q); renderQ(); }
        else if (q.uAns) moveQ(1);
    }
};

// æ‰¹é‡ç®¡ç†
function drawBatchUI() {
    const b = document.getElementById('batch-section');
    const c = document.getElementById('q-list-mini');
    if(!curBank) { b.style.display = 'none'; return; }
    b.style.display = 'block';
    c.innerHTML = curBank.qs.map(q => `
        <div style="display:flex; gap:5px; margin-bottom:4px;">
            <input type="checkbox" class="qb" value="${q.id}">
            <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${q.question}</span>
        </div>
    `).join('');
}
function doBatchDel() {
    const ids = Array.from(document.querySelectorAll('.qb:checked')).map(i => parseInt(i.value));
    if(!ids.length) return;
    if(confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${ids.length} é“é¢˜ç›®å—ï¼Ÿ`)) {
        curBank.qs = curBank.qs.filter(q => !ids.includes(q.id));
        curBank.wrongs = curBank.wrongs.filter(id => !ids.includes(id));
        const tx = db.transaction('banks', 'readwrite');
        tx.objectStore('banks').put(curBank).onsuccess = () => loadBank(curBank.id);
    }
}

// ==========================================
// ğŸš€ å¼ºåˆ¶å¸è½½ Service Worker (è§£å†³åŒæ­¥æ­»ç©´)
// ==========================================
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister();
            console.log('Service Worker å·²å¼ºåˆ¶å¸è½½ï¼Œç¡®ä¿åŠ è½½æœ€æ–°ä»£ç ');
        }
    });
}
// æ¸…é™¤ç¼“å­˜ API ä¸­çš„æ•°æ®
if ('caches' in window) {
    caches.keys().then(function(names) {
        for (let name of names) caches.delete(name);
    });
}
</script>
</body>
</html>
